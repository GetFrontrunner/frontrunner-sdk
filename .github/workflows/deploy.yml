name: Deploy
run-name: Deploy
on: [push]
# on:
#   push:
#     branches: [master]

jobs:

  GitHub-Pages:
    runs-on: ubuntu-latest
    container: slatedocs/slate:v2.13.1
    steps:
      - name: Prerequisites
        run: |
          apt-get update
          apt-get install -y git rsync
      - name: Checkout
        uses: actions/checkout@v3
      - name: Slate Build
        run: |
          repo_dir=$(pwd)

          # suppress "detected dubious ownership in repository" garbage
          git config --global --add safe.directory "${repo_dir}"

          commit_author_name=$(git log -n 1 --format="%an" HEAD)
          commit_author_email=$(git log -n 1 --format="%ae" HEAD)

          # need to configure user details manually
          git config --global user.name "${commit_author_name}"
          git config --global user.email "${commit_author_email}"

          rm --recursive --force /srv/slate/source
          cp --recursive docs /srv/slate/source
          # rsync --recursive --delete docs /srv/slate/source

          commit_title=$(git log -n 1 --format="%s" HEAD)
          commit_hash=$(git log -n 1 --format="%H" HEAD)
          commit_message=<<EOF
          publish: ${commit_title}

          generated from commit ${commit_hash}
          EOF

          cd /srv/slate
          ./slate.sh build

          cd "${repo_dir}"
          git fetch origin gh-pages
          git checkout gh-pages

          rsync --recursive --delete --exclude=.git /srv/slate/build/ .

          git commit --all --message "${commit_message}"

          git show
      # git push
